<!DOCTYPE html>
<html>
<head>
  <title>Manage Projects - ServeBoard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://*.msauth.net https://*.microsoftonline.com https://yafoc-serveboard.azurewebsites.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.msauth.net https://*.microsoftonline.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.msauth.net https://*.microsoftonline.com https://yafoc-serveboard.azurewebsites.net">
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
  <script src="scripts/msal-auth.js"></script>
  <script src="scripts/api.js"></script>
</head>
<body>
  <main class="page">
    <section class="card">
      <header class="page-header">
        <div>
          <h1 class="page-header__title">Staff Portal</h1>
          <p class="muted">Manage projects and volunteer slots for ServeBoard.</p>
        </div>
        <div class="page-header__actions">
          <button id="loginBtn" type="button" class="btn btn-primary btn-block-sm">Sign in with Microsoft</button>
          <button id="logoutBtn" type="button" class="btn btn-outline btn-block-sm is-hidden">Logout</button>
        </div>
      </header>
      <div id="userInfo" class="auth-info is-hidden"></div>
    </section>

    <div id="manageUI" class="stack is-hidden">
      <section class="card" id="projectOverviewCard">
        <div class="stack">
          <h2>Projects</h2>
          <p class="muted">Select an existing project to review or update, or choose <strong>New Project</strong> to create one.</p>
          <div class="page-toolbar">
            <button id="refreshProjects" type="button" class="btn btn-secondary btn-block-sm">Refresh Projects</button>
            <button id="toggleCreateProject" type="button" class="btn btn-primary btn-block-sm">New Project</button>
          </div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Project</th>
                <th>Category</th>
                <th>Volunteers</th>
                <th>Contact</th>
                <th>Email</th>
              </tr>
            </thead>
            <tbody id="projectsTableBody">
              <tr class="table-message"><td colspan="4">Sign in and refresh to load projects.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section id="projectDetailCard" class="card is-hidden">
        <header class="detail-header">
          <div class="stack">
            <h2 id="projectDetailTitle">Project Details</h2>
            <p id="projectDetailSubtitle" class="muted"></p>
          </div>
          <div class="detail-actions">
            <button id="editProjectBtn" type="button" class="btn btn-secondary btn-block-sm">Edit Project</button>
            <button id="backToProjects" type="button" class="btn btn-ghost btn-block-sm">Done with this project</button>
          </div>
        </header>

        <div class="table-container">
          <table class="kv-table">
            <tbody id="projectDetailBody"></tbody>
          </table>
        </div>

        <div class="stack">
          <div class="detail-header detail-header--sub">
            <h3>Slots</h3>
            <div class="detail-actions">
              <button id="addSlotBtn" type="button" class="btn btn-secondary btn-block-sm">Add Slot</button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Task</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Status</th>
                  <th>Spots</th>
                  <th class="nowrap">Actions</th>
                </tr>
              </thead>
              <tbody id="slotsTableBody">
                <tr class="table-message"><td colspan="6">Select a project to see its slots.</td></tr>
              </tbody>
            </table>
          </div>
          <div id="slotMsg" class="status-message"></div>

          <form id="slotForm" class="slot-form stack" novalidate>
            <h4 id="slotFormTitle">Add Slot</h4>
            <div class="form-grid two-col">
              <label class="form-field">
                <span class="form-label">Task</span>
                <input id="slotTask" name="task" placeholder="Describe the task" required />
              </label>
              <label class="form-field">
                <span class="form-label">Status</span>
                <select id="slotStatus" name="status">
                  <option value="available">Available</option>
                  <option value="filled">Filled</option>
                  <option value="held">Held</option>
                </select>
              </label>
              <label class="form-field">
                <span class="form-label">Date</span>
                <input id="slotDate" name="date" type="date" required />
              </label>
              <label class="form-field">
                <span class="form-label">Time</span>
                <input id="slotTime" name="time" type="time" required min="06:00" max="17:45" step="900" list="slotTimeOptions" value="06:00" />
              </label>
              <label class="form-field">
                <span class="form-label">Volunteers Needed</span>
                <input id="slotCapacity" name="capacity" type="number" min="1" step="1" required value="1" />
              </label>
              <div class="form-field">
                <span class="form-label">Spots Summary</span>
                <p id="slotSpotsSummary" class="muted">Spots remaining will appear when editing.</p>
              </div>
            </div>
            <div class="slot-actions">
              <button id="saveSlotBtn" type="submit" class="btn btn-primary btn-block-sm">Save Slot</button>
              <button id="cancelSlotBtn" type="button" class="btn btn-ghost btn-block-sm">Cancel</button>
            </div>
          </form>
          <section id="slotVolunteersSection" class="stack is-hidden">
            <h5>Volunteers</h5>
            <p id="slotVolunteersEmpty" class="muted">No one has signed up yet.</p>
            <ul id="slotVolunteersList" class="volunteer-list"></ul>
          </section>
        </div>
        <datalist id="slotTimeOptions">
          <option value="06:00"></option>
          <option value="06:15"></option>
          <option value="06:30"></option>
          <option value="06:45"></option>
          <option value="07:00"></option>
          <option value="07:15"></option>
          <option value="07:30"></option>
          <option value="07:45"></option>
          <option value="08:00"></option>
          <option value="08:15"></option>
          <option value="08:30"></option>
          <option value="08:45"></option>
          <option value="09:00"></option>
          <option value="09:15"></option>
          <option value="09:30"></option>
          <option value="09:45"></option>
          <option value="10:00"></option>
          <option value="10:15"></option>
          <option value="10:30"></option>
          <option value="10:45"></option>
          <option value="11:00"></option>
          <option value="11:15"></option>
          <option value="11:30"></option>
          <option value="11:45"></option>
          <option value="12:00"></option>
          <option value="12:15"></option>
          <option value="12:30"></option>
          <option value="12:45"></option>
          <option value="13:00"></option>
          <option value="13:15"></option>
          <option value="13:30"></option>
          <option value="13:45"></option>
          <option value="14:00"></option>
          <option value="14:15"></option>
          <option value="14:30"></option>
          <option value="14:45"></option>
          <option value="15:00"></option>
          <option value="15:15"></option>
          <option value="15:30"></option>
          <option value="15:45"></option>
          <option value="16:00"></option>
          <option value="16:15"></option>
          <option value="16:30"></option>
          <option value="16:45"></option>
          <option value="17:00"></option>
          <option value="17:15"></option>
          <option value="17:30"></option>
          <option value="17:45"></option>
        </datalist>
      </section>

      <section id="createProjectCard" class="card is-hidden">
        <div class="stack">
          <div class="detail-header detail-header--sub">
            <h2 id="projectFormTitle">Create New Project</h2>
            <div class="detail-actions">
              <button id="cancelCreateProject" type="button" class="btn btn-ghost btn-block-sm">Back to projects</button>
            </div>
          </div>
          <p class="muted" id="projectFormDescription">Capture the key details so your team knows who to contact and what needs to happen.</p>
        </div>
        <form id="createProjectForm" class="form-grid two-col">
          <label class="form-field">
            <span class="form-label">Project Title</span>
            <input name="title" placeholder="Project Title" required />
          </label>
          <label class="form-field">
            <span class="form-label">Project Description</span>
            <input name="description" placeholder="Project Description" required />
          </label>
          <label class="form-field">
            <span class="form-label">Contact Email</span>
            <input name="contactEmail" placeholder="Contact Email" required type="email" />
          </label>
          <label class="form-field">
            <span class="form-label">Contact First Name</span>
            <input name="contactFirstName" placeholder="Contact First Name" />
          </label>
          <label class="form-field">
            <span class="form-label">Contact Last Name</span>
            <input name="contactLastName" placeholder="Contact Last Name" />
          </label>
          <label class="form-field">
            <span class="form-label">Contact Phone</span>
            <input name="contactPhone" placeholder="Contact Phone" type="tel" />
          </label>
          <label class="form-field">
            <span class="form-label">Project Category</span>
            <input name="category" placeholder="Project Category" />
          </label>
          <button type="submit" class="btn btn-primary" id="projectSubmitBtn">Create Project</button>
        </form>
        <div id="projectMsg" class="status-message"></div>
      </section>
    </div>
  </main>
  <script>
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const manageUI = document.getElementById('manageUI');

    const projectOverviewCard = document.getElementById('projectOverviewCard');
    const projectsTableBody = document.getElementById('projectsTableBody');
    const refreshProjects = document.getElementById('refreshProjects');
    const toggleCreateProject = document.getElementById('toggleCreateProject');
    const createProjectCard = document.getElementById('createProjectCard');
    const cancelCreateProject = document.getElementById('cancelCreateProject');
    const createProjectForm = document.getElementById('createProjectForm');
    const projectMsg = document.getElementById('projectMsg');

    const projectFormTitle = document.getElementById('projectFormTitle');
    const projectFormDescription = document.getElementById('projectFormDescription');
    const projectSubmitBtn = document.getElementById('projectSubmitBtn');

    const projectDetailCard = document.getElementById('projectDetailCard');
    const projectDetailTitle = document.getElementById('projectDetailTitle');
    const projectDetailSubtitle = document.getElementById('projectDetailSubtitle');
    const projectDetailBody = document.getElementById('projectDetailBody');
    const backToProjects = document.getElementById('backToProjects');
    const editProjectBtn = document.getElementById('editProjectBtn');

    const slotsTableBody = document.getElementById('slotsTableBody');
    const slotMsg = document.getElementById('slotMsg');
    const addSlotBtn = document.getElementById('addSlotBtn');
    const slotForm = document.getElementById('slotForm');
    const slotFormTitle = document.getElementById('slotFormTitle');
    const slotTask = document.getElementById('slotTask');
    const slotStatus = document.getElementById('slotStatus');
    const slotDate = document.getElementById('slotDate');
    const slotTime = document.getElementById('slotTime');
    const slotCapacity = document.getElementById('slotCapacity');
    const slotSpotsSummary = document.getElementById('slotSpotsSummary');
    const slotVolunteersSection = document.getElementById('slotVolunteersSection');
    const slotVolunteersEmpty = document.getElementById('slotVolunteersEmpty');
    const slotVolunteersList = document.getElementById('slotVolunteersList');
    const cancelSlotBtn = document.getElementById('cancelSlotBtn');
  const slotVolunteersEmptyDefaultText = slotVolunteersEmpty.textContent;

    const show = (el) => el.classList.remove('is-hidden');
    const hide = (el) => el.classList.add('is-hidden');

    let projectsCache = [];
    let selectedProjectId = null;
    let activeProjectRow = null;
    let editingProjectId = null;
    let projectMessageClearHandle = null;
    let slotsCache = [];
    const normalizeSlotMetrics = (slot) => {
      const rawCapacity = parseInt(slot?.capacity, 10);
      const capacity = Number.isFinite(rawCapacity) && rawCapacity > 0 ? rawCapacity : 1;
      const rawFilled = parseInt(slot?.filledCount, 10);
      const fallbackFilled = slot?.volunteer ? 1 : 0;
      const filledCount = Math.max(0, Number.isFinite(rawFilled) ? rawFilled : fallbackFilled);
      const spotsRemaining = Math.max(0, capacity - filledCount);
      return { capacity, filledCount, spotsRemaining };
    };

    const describeSlotSpots = (slot) => {
      const { capacity, filledCount, spotsRemaining } = normalizeSlotMetrics(slot);
      const parts = [`${filledCount} of ${capacity} filled`];
      parts.push(spotsRemaining === 0 ? 'No open spots' : `${spotsRemaining} spot${spotsRemaining === 1 ? '' : 's'} open`);
  return { summary: parts.join(' / '), capacity, filledCount, spotsRemaining };
    };

    const renderSlotVolunteers = (volunteers, slotId) => {
      slotVolunteersList.innerHTML = '';
      if (!Array.isArray(volunteers) || volunteers.length === 0) {
        hide(slotVolunteersList);
        slotVolunteersEmpty.textContent = slotVolunteersEmptyDefaultText;
        show(slotVolunteersEmpty);
        return;
      }

      hide(slotVolunteersEmpty);
      slotVolunteersEmpty.textContent = slotVolunteersEmptyDefaultText;
      show(slotVolunteersList);

      volunteers.forEach((volunteer) => {
        const li = document.createElement('li');
        li.className = 'volunteer-list__item';

        const nameParts = [volunteer.firstName, volunteer.lastName].filter(Boolean);
        const name = nameParts.length > 0 ? nameParts.join(' ') : 'Volunteer';

        const info = document.createElement('div');
        info.className = 'volunteer-list__info';
        const nameSpan = document.createElement('span');
        nameSpan.className = 'volunteer-list__name';
        nameSpan.textContent = name;
        const metaSpan = document.createElement('span');
        metaSpan.className = 'volunteer-list__meta';
        const metaParts = [];
        if (volunteer.email) {
          metaParts.push(volunteer.email);
        } else {
          metaParts.push('No email provided');
        }
        if (volunteer.phone) {
          metaParts.push(volunteer.phone);
        }
        metaSpan.textContent = metaParts.join(' | ');
        info.append(nameSpan, metaSpan);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-ghost btn-inline';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', async () => {
          if (!selectedProjectId) return;
          const confirmed = window.confirm(`Remove ${name} from this slot?`);
          if (!confirmed) return;

          try {
            setSlotMessage('Removing volunteer...', null);
            const { status, data } = await window.api.apiCall(`/api/projects/${selectedProjectId}/slots/${slotId}/volunteers/${volunteer.id}`, 'DELETE');
            if (status >= 200 && status < 300) {
              setSlotMessage('Volunteer removed from slot.', 'success');
              const slotUpdate = data?.slot;
              if (slotUpdate) {
                const slotIndex = slotsCache.findIndex((s) => s.id === slotId);
                if (slotIndex !== -1) {
                  slotsCache[slotIndex] = {
                    ...slotsCache[slotIndex],
                    ...slotUpdate
                  };
                  renderSlotsTable(slotsCache);
                  if (slotForm.dataset.mode === 'edit' && slotForm.dataset.slotId === slotId) {
                    if (slotUpdate.status) {
                      const normalizedStatus = slotUpdate.status.toLowerCase();
                      const validStatuses = ['available', 'filled', 'held'];
                      if (validStatuses.includes(normalizedStatus)) {
                        slotStatus.value = normalizedStatus;
                      }
                    }
                    const metrics = describeSlotSpots(slotsCache[slotIndex]);
                    slotSpotsSummary.textContent = metrics.summary;
                  }
                }
              }
              await loadSlotVolunteers(slotId);
            } else {
              setSlotMessage(data?.error || 'Failed to remove volunteer.', 'error');
            }
          } catch (err) {
            console.error('Error removing volunteer:', err);
            setSlotMessage('There was a problem removing this volunteer.', 'error');
          }
        });

        li.append(info, removeBtn);
        slotVolunteersList.appendChild(li);
      });
    };


    const projectCreateDescriptionText = projectFormDescription.textContent;

    const scrollToElement = (element) => {
      if (!element) return;
      element.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    const resetProjectFormState = () => {
      editingProjectId = null;
      createProjectForm.dataset.mode = 'create';
      projectFormTitle.textContent = 'Create New Project';
      projectFormDescription.textContent = projectCreateDescriptionText;
      projectSubmitBtn.textContent = 'Create Project';
      createProjectForm.reset();
    };

    const populateProjectForm = (project) => {
      if (!project) return;

      editingProjectId = project.id;
      createProjectForm.dataset.mode = 'edit';
      projectFormTitle.textContent = 'Edit Project';
      projectFormDescription.textContent = 'Update the project details below.';
      projectSubmitBtn.textContent = 'Save Changes';

      createProjectForm.title.value = project.title || '';
      createProjectForm.description.value = project.description || '';
      createProjectForm.category.value = project.category || '';

      const contact = getContact(project);
      createProjectForm.contactEmail.value = contact.email || '';
      createProjectForm.contactFirstName.value = contact.firstName || '';
      createProjectForm.contactLastName.value = contact.lastName || '';
      createProjectForm.contactPhone.value = contact.phone || '';
    };

    resetProjectFormState();

    const getContact = (project) => {
      const contact = project.contact || {};
      return {
        firstName: contact.firstName ?? project.contactFirstName ?? '',
        lastName: contact.lastName ?? project.contactLastName ?? '',
        email: contact.email ?? project.contactEmail ?? '',
        phone: contact.phone ?? project.contactPhone ?? ''
      };
    };

    const setProjectMessage = (message, type) => {
      if (projectMessageClearHandle) {
        clearTimeout(projectMessageClearHandle);
        projectMessageClearHandle = null;
      }

      projectMsg.textContent = message || '';
      projectMsg.classList.remove('status-message--error', 'status-message--success');
      if (!message) return;
      if (type === 'error') {
        projectMsg.classList.add('status-message--error');
      } else if (type === 'success') {
        projectMsg.classList.add('status-message--success');
      }
    };

    const setSlotMessage = (message, type) => {
      slotMsg.textContent = message || '';
      slotMsg.classList.remove('status-message--error', 'status-message--success');
      if (!message) return;
      if (type === 'error') {
        slotMsg.classList.add('status-message--error');
      } else if (type === 'success') {
        slotMsg.classList.add('status-message--success');
      }
    };

    const clearActiveProjectRow = () => {
      if (activeProjectRow) {
        activeProjectRow.classList.remove('table-row--active');
      }
      activeProjectRow = null;
    };

    const resetProjectTableMessage = (message) => {
      projectsTableBody.innerHTML = '';
      const row = document.createElement('tr');
      row.className = 'table-message';
      const cell = document.createElement('td');
      cell.colSpan = 5;
      cell.textContent = message;
      row.appendChild(cell);
      projectsTableBody.appendChild(row);
    };

    const renderProjectsTable = () => {
      projectsTableBody.innerHTML = '';
      clearActiveProjectRow();

      if (!Array.isArray(projectsCache) || projectsCache.length === 0) {
        resetProjectTableMessage('No projects yet. Select New Project to create one.');
        selectedProjectId = null;
        hide(projectDetailCard);
        return;
      }

      projectsCache.forEach((project) => {
        const row = document.createElement('tr');
        row.dataset.projectId = project.id;
        const contact = getContact(project);
        const contactName = [contact.firstName, contact.lastName].filter(Boolean).join(' ').trim();
        const email = contact.email || 'N/A';
        const totalNeeded = Number.isFinite(project.totalVolunteersNeeded) ? project.totalVolunteersNeeded : 0;
        const totalFilled = Number.isFinite(project.totalVolunteersFilled) ? project.totalVolunteersFilled : 0;
        const totalRemaining = Number.isFinite(project.totalSpotsRemaining) ? project.totalSpotsRemaining : Math.max(0, totalNeeded - totalFilled);
        const volunteerSummary = `${totalFilled}/${totalNeeded}`;
        const volunteerDetail = totalRemaining > 0 ? `${totalRemaining} open` : 'Full';

        row.innerHTML = `
          <td>${project.title || 'Untitled project'}</td>
          <td>${project.category || 'General'}</td>
          <td>
            <div>${volunteerSummary}</div>
            <div class="muted">${volunteerDetail}</div>
          </td>
          <td>${contactName || 'Unassigned'}</td>
          <td>${email}</td>
        `;

        row.addEventListener('click', () => {
          if (activeProjectRow && activeProjectRow !== row) {
            activeProjectRow.classList.remove('table-row--active');
          }
          activeProjectRow = row;
          activeProjectRow.classList.add('table-row--active');
          openProjectDetail(project.id);
        });

        projectsTableBody.appendChild(row);
      });

      if (selectedProjectId) {
        const persistedRow = projectsTableBody.querySelector(`[data-project-id="${selectedProjectId}"]`);
        if (persistedRow) {
          activeProjectRow = persistedRow;
          activeProjectRow.classList.add('table-row--active');
        } else {
          selectedProjectId = null;
          hide(projectDetailCard);
        }
      }
    };

    const renderProjectDetail = (project) => {
      const contact = getContact(project);
      const contactName = [contact.firstName, contact.lastName].filter(Boolean).join(' ').trim();
      const totalNeeded = Number.isFinite(project.totalVolunteersNeeded) ? project.totalVolunteersNeeded : 0;
      const totalFilled = Number.isFinite(project.totalVolunteersFilled) ? project.totalVolunteersFilled : 0;
      const totalRemaining = Number.isFinite(project.totalSpotsRemaining) ? project.totalSpotsRemaining : Math.max(0, totalNeeded - totalFilled);
      projectDetailTitle.textContent = project.title || 'Project details';
      const metaParts = [project.category || 'Uncategorized'];
      if (contactName) metaParts.push(`Contact: ${contactName}`);
      metaParts.push(`Volunteers: ${totalFilled}/${totalNeeded}`);
      projectDetailSubtitle.textContent = metaParts.join(' | ');

      const rows = [
        ['Description', project.description || 'No description provided'],
        ['Category', project.category || 'General'],
        ['Contact email', contact.email || 'N/A'],
        ['Contact phone', contact.phone || 'N/A'],
        ['Total slots', project.totalSlots || 0],
        ['Volunteers filled', `${totalFilled} of ${totalNeeded}`],
        ['Open spots remaining', totalRemaining],
        ['Project ID', project.id]
      ];

      projectDetailBody.innerHTML = '';
      rows.forEach(([label, value]) => {
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.scope = 'row';
        th.textContent = label;
        const td = document.createElement('td');
        td.textContent = value;
        tr.append(th, td);
        projectDetailBody.appendChild(tr);
      });
    };

    const closeSlotForm = () => {
      slotForm.reset();
      slotStatus.value = 'available';
      slotForm.dataset.mode = '';
      delete slotForm.dataset.slotId;
      slotForm.classList.remove('active');
      slotSpotsSummary.textContent = 'Spots remaining will appear when editing.';
      hide(slotVolunteersSection);
      hide(slotVolunteersList);
      slotVolunteersEmpty.textContent = slotVolunteersEmptyDefaultText;
      show(slotVolunteersEmpty);
      slotVolunteersList.innerHTML = '';
    };

    const openSlotForm = (mode, slot = null) => {
      if (!selectedProjectId) return;
      slotForm.dataset.mode = mode;
      slotForm.dataset.slotId = slot?.id || '';
      slotFormTitle.textContent = mode === 'edit' ? 'Update Slot' : 'Add Slot';
      slotForm.reset();
      slotStatus.value = 'available';

      if (mode === 'edit' && slot) {
        slotTask.value = slot.task || slot.title || '';
        const statusValue = slot.status || 'available';
        slotStatus.value = ['available', 'filled', 'held'].includes(statusValue) ? statusValue : 'available';
        slotDate.value = slot.date || '';
        slotTime.value = slot.time || '';
        const metrics = describeSlotSpots(slot);
        slotCapacity.value = metrics.capacity;
        slotSpotsSummary.textContent = metrics.summary;
        show(slotVolunteersSection);
        loadSlotVolunteers(slot.id);
      } else {
        slotCapacity.value = 1;
        hide(slotVolunteersSection);
        slotSpotsSummary.textContent = 'Spots remaining will appear when editing.';
      }

      slotForm.classList.add('active');
      slotForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    const renderSlotsTable = (slots) => {
      slotsTableBody.innerHTML = '';

      if (!Array.isArray(slots) || slots.length === 0) {
        const row = document.createElement('tr');
        row.className = 'table-message';
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.textContent = 'No slots for this project yet.';
        row.appendChild(cell);
        slotsTableBody.appendChild(row);
        return;
      }

      slots.forEach((slot) => {
        const row = document.createElement('tr');
        row.dataset.slotId = slot.id;
        const metrics = describeSlotSpots(slot);
        const availabilityLabel = metrics.spotsRemaining === 0 ? 'Full' : `${metrics.spotsRemaining} open`;

        row.innerHTML = `
          <td>${slot.task || slot.title || 'Untitled slot'}</td>
          <td>${slot.date || 'N/A'}</td>
          <td>${slot.time || 'N/A'}</td>
          <td>${slot.status || 'available'}</td>
          <td>
            <div>${metrics.filledCount}/${metrics.capacity} filled</div>
            <div class="muted">${availabilityLabel}</div>
          </td>
          <td></td>
        `;

        const actionsCell = row.querySelector('td:last-child');
        actionsCell.classList.add('table-actions');

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'btn btn-outline btn-inline';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          openSlotForm('edit', slot);
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-ghost btn-inline';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', async (event) => {
          event.stopPropagation();
          if (!selectedProjectId) return;
          const confirmed = window.confirm(`Delete slot "${slot.task || slot.title || 'slot'}"?`);
          if (!confirmed) return;

          setSlotMessage('Deleting slot...', null);
          try {
            const { status } = await window.api.apiCall(`/api/projects/${selectedProjectId}/slots/${slot.id}`, 'DELETE');
            if (status === 204) {
              setSlotMessage('Slot deleted.', 'success');
              await loadSlots(selectedProjectId);
            } else {
              setSlotMessage('Failed to delete slot. Try again.', 'error');
            }
          } catch (err) {
            console.error('Slot deletion error:', err);
            setSlotMessage('Error deleting slot.', 'error');
          }
        });

        actionsCell.append(editBtn, deleteBtn);
        slotsTableBody.appendChild(row);
      });
    };

    const loadSlotVolunteers = async (slotId) => {
      if (!selectedProjectId || !slotId) return;

      show(slotVolunteersSection);
      hide(slotVolunteersList);
      slotVolunteersEmpty.textContent = 'Loading volunteers...';
      show(slotVolunteersEmpty);

      try {
        const { status, data } = await window.api.apiCall(`/api/projects/${selectedProjectId}/slots/${slotId}/volunteers`);
        if (status === 200) {
          renderSlotVolunteers(data?.volunteers ?? [], slotId);
        } else {
          slotVolunteersEmpty.textContent = data?.error || 'Failed to load volunteers for this slot.';
        }
      } catch (err) {
        console.error('Error loading slot volunteers:', err);
        slotVolunteersEmpty.textContent = 'Error loading volunteers for this slot.';
        hide(slotVolunteersList);
        show(slotVolunteersEmpty);
      }

      const slotEntry = slotsCache.find((s) => s.id === slotId);
      if (slotEntry) {
        const metrics = describeSlotSpots(slotEntry);
        slotSpotsSummary.textContent = metrics.summary;
      }
    };

    const loadSlots = async (projectId) => {
      slotsTableBody.innerHTML = '';
      const loadingRow = document.createElement('tr');
      loadingRow.className = 'table-message';
      const loadingCell = document.createElement('td');
      loadingCell.colSpan = 6;
      loadingCell.textContent = 'Loading slots...';
      loadingRow.appendChild(loadingCell);
      slotsTableBody.appendChild(loadingRow);

      setSlotMessage('', null);
      closeSlotForm();

      try {
        const { status, data } = await window.api.apiCall(`/api/projects/${projectId}/slots`);
        if (status === 200) {
          slotsCache = Array.isArray(data) ? [...data] : [];
          renderSlotsTable(slotsCache);
        } else {
          slotsCache = [];
          setSlotMessage('Unable to load slots right now.', 'error');
          renderSlotsTable(slotsCache);
        }
      } catch (err) {
        console.error('Error loading slots:', err);
        setSlotMessage('Error loading slots.', 'error');
        slotsCache = [];
        renderSlotsTable(slotsCache);
      }
    };

    const openProjectDetail = async (projectId) => {
      const project = projectsCache.find((p) => p.id === projectId);
      if (!project) return;

      selectedProjectId = projectId;
      if (createProjectForm.dataset.mode === 'edit') {
        resetProjectFormState();
        setProjectMessage('', null);
        hide(createProjectCard);
      }
      renderProjectDetail(project);
      show(projectDetailCard);
      scrollToElement(projectDetailCard);
      await loadSlots(projectId);
    };

    const loadProjects = async () => {
      resetProjectTableMessage('Loading projects...');
      hide(projectDetailCard);
      setSlotMessage('', null);
      closeSlotForm();

      try {
        const { status, data } = await window.api.apiCall('/api/projects');
        if (status !== 200) {
          resetProjectTableMessage('Unable to load projects right now. Please try refreshing.');
          return;
        }

        projectsCache = Array.isArray(data) ? [...data] : [];
        projectsCache.sort((a, b) => (a.title || '').localeCompare(b.title || '', undefined, { sensitivity: 'base' }));

        renderProjectsTable();

        if (selectedProjectId) {
          await openProjectDetail(selectedProjectId);
        }
      } catch (err) {
        console.error('Error loading projects:', err);
        resetProjectTableMessage('Error loading projects. Please try again later.');
      }
    };

    const applyAuthState = (account) => {
      if (account) {
        hide(loginBtn);
        show(logoutBtn);
        userInfo.textContent = `Signed in as: ${account.username}`;
        show(userInfo);
        show(manageUI);
        loadProjects();
      } else {
        show(loginBtn);
        hide(logoutBtn);
        hide(userInfo);
        hide(manageUI);
        hide(projectDetailCard);
        hide(createProjectCard);
        resetProjectFormState();
        clearActiveProjectRow();
        selectedProjectId = null;
        projectsTableBody.innerHTML = '';
        setProjectMessage('', null);
        setSlotMessage('', null);
        closeSlotForm();
      }
    };

    window.msalAuth.onAuthStateChanged(applyAuthState);

    loginBtn.addEventListener('click', () => {
      window.msalAuth.signIn();
    });

    logoutBtn.addEventListener('click', async () => {
      await window.msalAuth.signOut();
      applyAuthState(null);
    });

    refreshProjects.addEventListener('click', loadProjects);

    toggleCreateProject.addEventListener('click', () => {
      const isHidden = createProjectCard.classList.contains('is-hidden');
      const isEditMode = createProjectForm.dataset.mode === 'edit';

      if (isHidden) {
        resetProjectFormState();
        setProjectMessage('', null);
        show(createProjectCard);
        scrollToElement(createProjectCard);
        return;
      }

      if (isEditMode) {
        resetProjectFormState();
        setProjectMessage('', null);
        scrollToElement(createProjectCard);
        return;
      }

      hide(createProjectCard);
      resetProjectFormState();
      setProjectMessage('', null);
    });

    cancelCreateProject.addEventListener('click', () => {
      hide(createProjectCard);
      resetProjectFormState();
      setProjectMessage('', null);
      scrollToElement(projectOverviewCard);
    });

    editProjectBtn.addEventListener('click', () => {
      if (!selectedProjectId) return;
      const project = projectsCache.find((p) => p.id === selectedProjectId);
      if (!project) return;
      populateProjectForm(project);
      setProjectMessage('', null);
      show(createProjectCard);
      scrollToElement(createProjectCard);
    });

    backToProjects.addEventListener('click', () => {
      hide(projectDetailCard);
      clearActiveProjectRow();
      selectedProjectId = null;
      setSlotMessage('', null);
      closeSlotForm();
      slotsTableBody.innerHTML = '';
      const row = document.createElement('tr');
      row.className = 'table-message';
      const cell = document.createElement('td');
      cell.colSpan = 6;
      cell.textContent = 'Select a project to see its slots.';
      row.appendChild(cell);
      slotsTableBody.appendChild(row);
      hide(createProjectCard);
      resetProjectFormState();
      setProjectMessage('', null);
      scrollToElement(projectOverviewCard);
    });

    addSlotBtn.addEventListener('click', () => openSlotForm('create'));
    cancelSlotBtn.addEventListener('click', () => {
      closeSlotForm();
      setSlotMessage('', null);
    });

    slotForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!selectedProjectId) {
        setSlotMessage('Select a project before adding slots.', 'error');
        return;
      }

      const mode = slotForm.dataset.mode || 'create';
      const slotId = slotForm.dataset.slotId;

      const task = slotTask.value.trim();
      const date = slotDate.value;
      const time = slotTime.value;
      const statusValue = slotStatus.value;
      const capacityRaw = parseInt(slotCapacity.value, 10);
      const capacityValue = Number.isFinite(capacityRaw) && capacityRaw > 0 ? capacityRaw : NaN;

      if (!task || !date || !time) {
        setSlotMessage('Task, date, and time are required.', 'error');
        return;
      }

      if (!Number.isFinite(capacityValue)) {
        setSlotMessage('Enter how many volunteers are needed (whole number greater than zero).', 'error');
        return;
      }

      const basePayload = { task, date, time, capacity: capacityValue };
      const updatePayload = mode === 'edit' ? { ...basePayload, status: statusValue } : basePayload;

      try {
        setSlotMessage('Saving slot...', null);
        if (mode === 'edit' && slotId) {
          const { status, data } = await window.api.apiCall(`/api/projects/${selectedProjectId}/slots/${slotId}`, 'PATCH', updatePayload);
          if (status >= 200 && status < 300) {
            setSlotMessage('Slot updated.', 'success');
            const slotIndex = slotsCache.findIndex((s) => s.id === slotId);
            if (slotIndex !== -1 && data?.slot) {
              slotsCache[slotIndex] = {
                ...slotsCache[slotIndex],
                ...data.slot,
                task,
                date,
                time,
                status: updatePayload.status
              };
              renderSlotsTable(slotsCache);
            }
          } else {
            setSlotMessage('Failed to update slot. Please try again.', 'error');
            return;
          }
        } else {
          const { status } = await window.api.apiCall(`/api/projects/${selectedProjectId}/slots`, 'POST', basePayload);
          if (status === 201) {
            setSlotMessage('Slot created.', 'success');
          } else {
            setSlotMessage('Failed to create slot. Please try again.', 'error');
            return;
          }
        }

        closeSlotForm();
        await loadSlots(selectedProjectId);
      } catch (err) {
        console.error('Slot save error:', err);
        setSlotMessage('There was a problem saving the slot.', 'error');
      }
    });

    createProjectForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      const mode = createProjectForm.dataset.mode || 'create';
      const targetProjectId = mode === 'edit' ? editingProjectId : null;

      const formData = new FormData(createProjectForm);
      const project = {
        title: formData.get('title')?.trim(),
        description: formData.get('description')?.trim(),
        category: formData.get('category')?.trim(),
        contactEmail: formData.get('contactEmail')?.trim(),
        contactFirstName: formData.get('contactFirstName')?.trim(),
        contactLastName: formData.get('contactLastName')?.trim(),
        contactPhone: formData.get('contactPhone')?.trim()
      };

      if (!project.title || !project.description || !project.contactEmail) {
        setProjectMessage('Please fill in the required fields (Title, Description, Contact Email).', 'error');
        return;
      }

      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(project.contactEmail)) {
        setProjectMessage('Please enter a valid email address.', 'error');
        return;
      }

      try {
        if (mode === 'edit') {
          if (!targetProjectId) {
            setProjectMessage('Select a project to edit before saving.', 'error');
            return;
          }

          setProjectMessage('Saving project changes...', null);
          const { status, data } = await window.api.apiCall(`/api/projects/${targetProjectId}`, 'PATCH', project);
          if (status >= 200 && status < 300) {
            setProjectMessage('Project updated successfully.', 'success');
            selectedProjectId = targetProjectId;
            await loadProjects();
            resetProjectFormState();
            hide(createProjectCard);
            scrollToElement(projectDetailCard);
            projectMessageClearHandle = setTimeout(() => setProjectMessage('', null), 2000);
          } else {
            setProjectMessage(data?.error || 'Failed to update project. Please try again.', 'error');
          }
        } else {
          setProjectMessage('Creating project...', null);
          const { status, data } = await window.api.apiCall('/api/projects', 'POST', project);
          if (status === 201) {
            setProjectMessage('Project created successfully.', 'success');
            await loadProjects();
            resetProjectFormState();
            hide(createProjectCard);
            scrollToElement(projectOverviewCard);
            projectMessageClearHandle = setTimeout(() => setProjectMessage('', null), 2000);
          } else {
            setProjectMessage(data?.error || 'Failed to create project. Please try again.', 'error');
          }
        }
      } catch (err) {
        console.error('Project creation error:', err);
        setProjectMessage(mode === 'edit' ? 'Error updating project. Please try again.' : 'Error creating project. Please try again.', 'error');
      }
    });
  </script>
</body>
</html>