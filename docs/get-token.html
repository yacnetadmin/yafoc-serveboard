<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Access Token</title>
    <link rel="stylesheet" href="assets/style.css">
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.js"></script>
    <script src="scripts/msal-auth.js?v=1"></script>
</head>
<body>
    <main class="page page--narrow">
        <section class="card">
            <h1 class="center-text">Get Access Token</h1>
            <p class="muted center-text">Sign in with your ministry account to copy a token for the admin CLI tools.</p>
            <div id="status" class="status-message"></div>
            <div class="project-controls">
                <button id="signInBtn" type="button" class="btn btn-primary btn-block-sm">Sign In with Microsoft</button>
                <button id="getTokenBtn" type="button" class="btn btn-secondary btn-block-sm is-hidden">Get Token</button>
            </div>
            <div id="tokenSection" class="stack is-hidden">
                <h3>Your Access Token</h3>
                <pre id="token" class="token-area"></pre>
            </div>
        </section>
    </main>
    <script>
        const status = document.getElementById('status');
        const signInBtn = document.getElementById('signInBtn');
        const getTokenBtn = document.getElementById('getTokenBtn');
        const tokenSection = document.getElementById('tokenSection');
        const tokenText = document.getElementById('token');

        const show = (el) => el.classList.remove('is-hidden');
        const hide = (el) => el.classList.add('is-hidden');

        const setStatus = (message, type = 'info') => {
            status.textContent = message;
            status.classList.remove('status-message--error', 'status-message--success');
            if (type === 'error') {
                status.classList.add('status-message--error');
            } else if (type === 'success') {
                status.classList.add('status-message--success');
            }
        };

        const applyAccountState = (account) => {
            if (account) {
                setStatus(`Signed in as: ${account.username}`, 'success');
                hide(signInBtn);
                show(getTokenBtn);
            } else {
                setStatus('Sign in to retrieve a token.');
                show(signInBtn);
                hide(getTokenBtn);
                hide(tokenSection);
            }
        };

        async function handleSignIn() {
            setStatus('Signing in...');
            window.msalAuth.signIn();
        }

        async function getAndShowToken() {
            setStatus('Getting token...');
            const token = await window.msalAuth.getAccessToken();
            if (token) {
                tokenText.textContent = token;
                show(tokenSection);
                setStatus('Token acquired successfully. Copy it for use in the admin script.', 'success');
            } else {
                setStatus('Redirecting to refresh your sign-inâ€¦', 'info');
            }
        }

        signInBtn.addEventListener('click', handleSignIn);
        getTokenBtn.addEventListener('click', getAndShowToken);

        window.msalAuth.onAuthStateChanged(applyAccountState);
        applyAccountState(window.msalAuth.getActiveAccount());
    </script>
</body>
</html>